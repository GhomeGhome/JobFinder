<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="/TEMPLATES/applicantTemplate.xhtml">
    <ui:define name="title">Edit Profile ‚Äì JobFinder</ui:define>

    <ui:define name="content">
        <div class="page-header">
            <h1>Edit Profile</h1>
            <p class="page-subtitle">Update your personal information, CV, and skills.</p>
        </div>

        <div style="display: flex; gap: 32px; align-items: start; flex-wrap: wrap;">

            <div class="card" style="text-align: center; width: 250px; flex-shrink: 0;">
                <img src="#{profileViewBean.getAvatarUrl(loginBean.loggedApplicant)}"
                     id="bigAvatar"
                     alt="Avatar"
                     style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin-bottom: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);" />

                <div style="margin-bottom: 16px;">
                    <span class="status-badge">Applicant</span>
                </div>

                <div class="field" style="text-align: left; margin-bottom: 16px;">
                    <label class="field-label" style="font-size: 12px;">Choose an Avatar</label>
                    <script>
                        function selectAvatar(url) {
                            // Update hidden input inside the profile form so it gets submitted
                            var hidden = document.getElementById("hiddenAvatarUrlForm");
                            if (hidden) hidden.value = url;

                            // Update the visual image
                            var bigImg = document.getElementById("bigAvatar");
                            if (bigImg) bigImg.src = url;
                        }
                    </script>

                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; justify-content: center;">

                        <img src="https://avataaars.io/?avatarStyle=Circle&amp;topType=ShortHairShortFlat&amp;accessoriesType=Sunglasses&amp;hairColor=Black&amp;facialHairType=Blank&amp;clotheType=Hoodie&amp;clotheColor=Blue03&amp;eyeType=Happy&amp;eyebrowType=Default&amp;mouthType=Smile&amp;skinColor=Light"
                             onclick="selectAvatar(this.src)" title="Option 1"
                             style="width: 45px; height: 45px; cursor: pointer; border-radius: 50%; transition: transform 0.2s;"
                             onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" />

                        <img src="https://avataaars.io/?avatarStyle=Circle&amp;topType=LongHairStraight&amp;accessoriesType=Blank&amp;hairColor=BrownDark&amp;facialHairType=Blank&amp;clotheType=BlazerShirt&amp;eyeType=Default&amp;eyebrowType=Default&amp;mouthType=Default&amp;skinColor=Light"
                             onclick="selectAvatar(this.src)" title="Option 2"
                             style="width: 45px; height: 45px; cursor: pointer; border-radius: 50%; transition: transform 0.2s;"
                             onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" />

                        <img src="https://avataaars.io/?avatarStyle=Circle&amp;topType=ShortHairDreads01&amp;accessoriesType=Blank&amp;hairColor=Black&amp;facialHairType=BeardLight&amp;clotheType=BlazerSweater&amp;eyeType=Happy&amp;eyebrowType=Default&amp;mouthType=Smile&amp;skinColor=Brown"
                             onclick="selectAvatar(this.src)" title="Option 3"
                             style="width: 45px; height: 45px; cursor: pointer; border-radius: 50%; transition: transform 0.2s;"
                             onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" />

                        <img src="https://avataaars.io/?avatarStyle=Circle&amp;topType=LongHairBob&amp;accessoriesType=Prescription02&amp;hairColor=Blonde&amp;facialHairType=Blank&amp;clotheType=ShirtCrewNeck&amp;eyeType=Happy&amp;eyebrowType=Default&amp;mouthType=Smile&amp;skinColor=Light"
                             onclick="selectAvatar(this.src)" title="Option 4"
                             style="width: 45px; height: 45px; cursor: pointer; border-radius: 50%; transition: transform 0.2s;"
                             onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'" />
                    </div>
                </div>

                <h:link outcome="/applicantProfileView.xhtml" styleClass="btn btn-light btn-full">
                    <f:param name="id" value="#{loginBean.loggedApplicant.id}" />
                    üëÅÔ∏è View Public Profile
                </h:link>
            </div>


            <div style="width: 100%; max-width: 300px;">
                <h3 style="margin-top:0;">Skills (ESCO)</h3>
                <h:form id="skillForm">
                    <div class="field">
                        <span class="field-label">Search skills</span>
                        <h:inputText value="#{skillBean.query}" styleClass="input-full" id="skillQuery">
                            <f:ajax event="keyup" listener="#{skillBean.refreshSuggestions}" render="suggestionsPanel" />
                        </h:inputText>
                    </div>

                    <h:panelGroup id="suggestionsPanel">
                        <ui:fragment rendered="#{not empty skillBean.suggestions}">
                            <ul class="suggestions-list" style="background:white; border:1px solid #ddd; list-style:none; padding:0;">
                                <ui:repeat value="#{skillBean.suggestions}" var="s">
                                    <li style="padding:8px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                                        #{s['label']}
                                        <h:commandLink value="Add" style="color:#2563eb; font-weight:bold;" action="#{skillBean.addSkill(s)}">
                                            <f:ajax render="selectedSkillsPanel :profileForm:manualSkillsInput" />
                                        </h:commandLink>
                                    </li>
                                </ui:repeat>
                            </ul>
                        </ui:fragment>
                    </h:panelGroup>

                    <h:panelGroup id="selectedSkillsPanel">
                        <ui:fragment rendered="#{not empty skillBean.selectedSkills}">
                            <div class="chip-container" style="margin-top:10px;">
                                <ui:repeat value="#{skillBean.selectedSkills}" var="s">
                                    <span class="chip" style="background:#e0f2fe; color:#0284c7; padding:4px 8px; border-radius:12px; margin-right:5px; font-size:12px;">
                                        #{s['label']}
                                        <h:commandLink value="√ó" action="#{skillBean.removeSkill(s)}" style="margin-left:4px; color:#0284c7; text-decoration:none;">
                                            <f:ajax render="selectedSkillsPanel :profileForm:manualSkillsInput" />
                                        </h:commandLink>
                                    </span>
                                </ui:repeat>
                            </div>
                        </ui:fragment>
                    </h:panelGroup>
                </h:form>
            </div>


            <div class="card" style="flex-grow: 1; min-width: 300px;">
                <h:form id="profileForm">
                    <input type="hidden" name="hiddenAvatarUrl" id="hiddenAvatarUrlForm"
                           value="#{loginBean.loggedApplicant.photoUrl}" />
                    <h:messages globalOnly="true"
                                style="list-style:none; padding:0; margin-bottom:16px;"
                                infoStyle="color: #15803d; background-color: #dcfce7; padding: 10px; border-radius: 6px; border: 1px solid #bbf7d0; display: block;"
                                errorStyle="color: #b91c1c; background-color: #fee2e2; padding: 10px; border-radius: 6px; border: 1px solid #fecaca; display: block;" />

                    <h3 style="margin-top: 0; margin-bottom: 16px; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 8px;">
                        Personal Information
                    </h3>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="field">
                            <span class="field-label">First Name</span>
                            <h:inputText value="#{loginBean.loggedApplicant.firstName}" styleClass="input-full" required="true" />
                        </div>
                        <div class="field">
                            <span class="field-label">Last Name</span>
                            <h:inputText value="#{loginBean.loggedApplicant.lastName}" styleClass="input-full" required="true" />
                        </div>
                    </div>

                    <div class="field">
                        <span class="field-label">City / Contact Info</span>
                        <h:inputText value="#{loginBean.loggedApplicant.contactInfo}" styleClass="input-full" />
                    </div>

                    <div class="field">
                        <span class="field-label">About Me (Description)</span>
                        <h:inputTextarea value="#{loginBean.loggedApplicant.descriptionInfo}" styleClass="input-full" rows="3" />
                    </div>

                    <h3 style="margin-top: 24px; margin-bottom: 16px; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 8px;">
                        Professional Details
                    </h3>

                    <div class="field">
                        <span class="field-label">CV / Resume</span>
                        
                        <!-- Show current CV if exists -->
                        <h:panelGroup rendered="#{not empty loginBean.loggedApplicant.cvInfo}">
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 8px; margin-bottom: 8px;">
                                <span style="font-size: 24px;">üìÑ</span>
                                <div style="flex-grow: 1;">
                                    <p style="margin: 0; font-weight: 600; color: #166534;">CV Uploaded</p>
                                    <p style="margin: 2px 0 0 0; font-size: 12px; color: #6b7280; word-break: break-all;">#{loginBean.loggedApplicant.cvInfo}</p>
                                </div>
                                <a href="#{loginBean.loggedApplicant.cvInfo}" target="_blank" 
                                   style="background: #22c55e; color: white; padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 12px; font-weight: 500;">
                                    View
                                </a>
                            </div>
                        </h:panelGroup>
                        
                        <!-- Hidden field to preserve current CV value -->
                        <h:inputHidden value="#{loginBean.loggedApplicant.cvInfo}" />
                        
                        <small style="color: #6b7280">Your CV is saved. Upload a new PDF below to replace it.</small>
                    </div>

                    <div class="field">
                        <span class="field-label">Manual Skills (Optional)</span>
                        <h:inputText id="manualSkillsInput"
                                     value="#{loginBean.loggedApplicant.skillsAsString}"
                                     styleClass="input-full" />
                        <small style="color: #6b7280">E.g., [Java, Python, SQL]</small>
                    </div>

                    <h3 style="margin-top: 24px; margin-bottom: 16px; font-size: 18px; border-bottom: 1px solid #eee; padding-bottom: 8px; color: #dc2626;">
                        Account Security
                    </h3>

                    <div class="field">
                        <span class="field-label">Email Address</span>
                        <h:inputText value="#{loginBean.loggedApplicant.email}"
                                     styleClass="input-full"
                                     readonly="true"
                                     style="background-color: #f3f4f6; color: #6b7280;" />
                        <small>Email cannot be changed directly.</small>
                    </div>

                    <div class="field">
                        <span class="field-label">New Password</span>
                        <h:inputSecret value="#{loginBean.loggedApplicant.password}" styleClass="input-full" redisplay="true" />
                    </div>

                    <div style="margin-top: 32px;">
                        <h:commandButton value="Save Changes"
                                         action="#{userBean.updateProfile}"
                                         styleClass="btn btn-primary btn-full" />
                    </div>
                </h:form>

                <h:form enctype="multipart/form-data" style="margin-top:8px;">
                    <div class="field">
                        <span class="field-label">Upload PDF</span>
                        <h:inputFile value="#{uploadBean.cvFile}" styleClass="input-full" />
                    </div>
                    <h:commandButton value="Upload CV (PDF)"
                                     action="#{uploadBean.uploadCv}"
                                     styleClass="btn btn-light" />
                    <h:messages styleClass="form-messages" />
                </h:form>
            </div>
        </div>
    </ui:define>
</ui:composition>