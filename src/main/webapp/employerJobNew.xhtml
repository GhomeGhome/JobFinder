<!DOCTYPE html>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                template="/TEMPLATES/employerTemplate.xhtml">

    <f:metadata>
        <f:viewAction action="#{employerJobFormBean.resetForm}" onPostback="false" />
    </f:metadata>

    <ui:define name="title">
        New Job Post – JobFinder
    </ui:define>

    <ui:define name="content">

        <div class="page-header">
            <h1>Create a new job post</h1>
            <p class="page-subtitle">
                Publish a new job offer for your company.
            </p>
        </div>

        <div class="card" style="max-width: 720px;">
            <h:form>
                <h:messages styleClass="form-messages" 
                           infoStyle="color: #15803d; background-color: #dcfce7; padding: 10px; border-radius: 6px; border: 1px solid #bbf7d0; display: block; margin-bottom: 12px;"
                           errorStyle="color: #b91c1c; background-color: #fee2e2; padding: 10px; border-radius: 6px; border: 1px solid #fecaca; display: block; margin-bottom: 12px;" />

                <!-- Title -->
                <div class="field">
                    <span class="field-label">Job title</span>
                    <h:inputText value="#{employerJobFormBean.jobOffer.title}"
                                 styleClass="input-full"
                                 required="true" />
                </div>

                <!-- Company -->
                <div class="field">
                    <span class="field-label">Company</span>
                    <h:selectOneMenu value="#{employerJobFormBean.selectedCompanyId}"
                                     styleClass="input-full" required="true">
                        <f:selectItem itemLabel="Select a company…" itemValue="" />
                        <f:selectItems value="#{employerJobFormBean.availableCompanies}"
                                       var="c"
                                       itemLabel="#{c.name}"
                                       itemValue="#{c.id}" />
                    </h:selectOneMenu>
                    <small style="color:#6b7280;">
                        Only companies you own are listed here.
                    </small>
                </div>

                <!-- Status -->
                <div class="field">
                    <span class="field-label">Status</span>
                    <h:selectOneMenu value="#{employerJobFormBean.statusString}"
                                     styleClass="input-full">
                        <f:selectItem itemLabel="Draft" itemValue="Draft" />
                        <f:selectItem itemLabel="Published" itemValue="Published" />
                        <f:selectItem itemLabel="Closed" itemValue="Closed" />
                    </h:selectOneMenu>
                </div>

                <!-- Description -->
                <div class="field">
                    <span class="field-label">Description</span>
                    <h:inputTextarea value="#{employerJobFormBean.jobOffer.description}"
                                     styleClass="input-full"
                                     rows="5"
                                     required="true" />
                </div>

                <!-- Required skills (manual quick add) -->
                <div class="field">
                    <span class="field-label">Required skills</span>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <h:inputText id="reqSkillInput"
                                     value="#{employerJobFormBean.requiredSkillInput}"
                                     styleClass="input-full"
                                     style="max-width:380px;"
                                     placeholder="e.g., java, sql, spring" />
                        <h:commandButton value="Add"
                                         action="#{employerJobFormBean.addRequiredSkill}"
                                         styleClass="btn btn-primary"
                                         style="padding: 8px 16px;">
                            <f:ajax execute="reqSkillInput" render="requiredSkillsPanel reqSkillInput" />
                        </h:commandButton>
                    </div>
                    <small style="color:#6b7280;">Add one or multiple (comma-separated). They will be used to compute match scores.</small>

                    <h:panelGroup id="requiredSkillsPanel">
                        <ui:fragment rendered="#{not empty employerJobFormBean.jobOffer.requiredSkills}">
                            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                                <ui:repeat value="#{employerJobFormBean.jobOffer.requiredSkills}" var="s">
                                    <span class="status-badge" style="background:#e0f2fe; color:#0284c7; display:inline-flex; align-items:center; gap:6px;">
                                        #{s}
                                        <h:commandLink value="×"
                                                       action="#{employerJobFormBean.removeRequiredSkill(s)}"
                                                       style="text-decoration:none; color:#0284c7; font-weight:bold;">
                                            <f:ajax render="requiredSkillsPanel" />
                                        </h:commandLink>
                                    </span>
                                </ui:repeat>
                            </div>
                        </ui:fragment>
                    </h:panelGroup>
                </div>

                <!-- ESCO picker for Required skills -->
                <div class="field">
                    <span class="field-label">Search skills (ESCO)</span>
                    <h:inputText value="#{jobReqBean.skillQuery}" styleClass="input-full" id="escoSkillQuery">
                        <f:ajax event="keyup" execute="@this" listener="#{jobReqBean.refreshSkillSuggestions}" render="escoSkillSuggestions escoSelectedSkills" />
                    </h:inputText>

                    <h:panelGroup id="escoSkillSuggestions">
                        <ui:fragment rendered="#{not empty jobReqBean.skillSuggestions}">
                            <ul class="suggestions-list" style="background:white; border:1px solid #ddd; list-style:none; padding:0; margin-top:8px; border-radius:8px;">
                                <ui:repeat value="#{jobReqBean.skillSuggestions}" var="s">
                                    <li style="padding:10px 12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                                        <h:outputText value="#{s['label']}" />
                                        <h:commandButton value="+ Add" 
                                                         actionListener="#{jobReqBean.addSelectedSkill}"
                                                         immediate="true"
                                                         style="background:#22c55e; color:white; padding:4px 12px; font-size:12px; border:none; border-radius:4px; cursor:pointer;">
                                            <f:setPropertyActionListener target="#{jobReqBean.selectedSkillLabel}" value="#{s['label']}" />
                                            <f:ajax render="requiredSkillsPanel escoSelectedSkills" />
                                        </h:commandButton>
                                    </li>
                                </ui:repeat>
                            </ul>
                        </ui:fragment>
                    </h:panelGroup>

                    <h:panelGroup id="escoSelectedSkills">
                        <ui:fragment rendered="#{not empty employerJobFormBean.jobOffer.requiredSkills}">
                            <div class="chip-container" style="margin-top:10px;">
                                <ui:repeat value="#{employerJobFormBean.jobOffer.requiredSkills}" var="s">
                                    <span class="chip" style="background:#e0f2fe; color:#0284c7; padding:4px 8px; border-radius:12px; margin-right:5px; font-size:12px;">
                                        #{s}
                                        <h:commandLink value="×" action="#{jobReqBean.removeSkill(s)}" style="margin-left:4px; color:#0284c7; text-decoration:none;">
                                            <f:ajax render="requiredSkillsPanel escoSelectedSkills" />
                                        </h:commandLink>
                                    </span>
                                </ui:repeat>
                            </div>
                        </ui:fragment>
                    </h:panelGroup>
                </div>

                <!-- ESCO picker for Required qualifications -->
                <div class="field">
                    <span class="field-label">Search qualifications (ESCO)</span>
                    <h:inputText value="#{jobReqBean.qualificationQuery}" styleClass="input-full" id="escoQualQuery">
                        <f:ajax event="keyup" execute="@this" listener="#{jobReqBean.refreshQualificationSuggestions}" render="escoQualSuggestions escoSelectedQuals" />
                    </h:inputText>

                    <h:panelGroup id="escoQualSuggestions">
                        <ui:fragment rendered="#{not empty jobReqBean.qualificationSuggestions}">
                            <ul class="suggestions-list" style="background:white; border:1px solid #ddd; list-style:none; padding:0; margin-top:8px; border-radius:8px;">
                                <ui:repeat value="#{jobReqBean.qualificationSuggestions}" var="q">
                                    <li style="padding:10px 12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                                        <h:outputText value="#{q['label']}" />
                                        <h:commandButton value="+ Add"
                                                         actionListener="#{jobReqBean.addSelectedQualification}"
                                                         immediate="true"
                                                         style="background:#f59e0b; color:white; padding:4px 12px; font-size:12px; border:none; border-radius:4px; cursor:pointer;">
                                            <f:setPropertyActionListener target="#{jobReqBean.selectedQualificationLabel}" value="#{q['label']}" />
                                            <f:ajax render="escoSelectedQuals" />
                                        </h:commandButton>
                                    </li>
                                </ui:repeat>
                            </ul>
                        </ui:fragment>
                    </h:panelGroup>

                    <h:panelGroup id="escoSelectedQuals">
                        <ui:fragment rendered="#{not empty employerJobFormBean.jobOffer.requiredQualifications}">
                            <div class="chip-container" style="margin-top:10px;">
                                <ui:repeat value="#{employerJobFormBean.jobOffer.requiredQualifications}" var="q">
                                    <span class="chip" style="background:#fef3c7; color:#b45309; padding:4px 8px; border-radius:12px; margin-right:5px; font-size:12px;">
                                        #{q}
                                        <h:commandLink value="×" action="#{jobReqBean.removeQualification(q)}" style="margin-left:4px; color:#b45309; text-decoration:none;">
                                            <f:ajax render="escoSelectedQuals" />
                                        </h:commandLink>
                                    </span>
                                </ui:repeat>
                            </div>
                        </ui:fragment>
                    </h:panelGroup>
                </div>

                <div style="margin-top: 24px; display:flex; gap:16px;">
                    <h:commandButton value="Create job"
                                     action="#{employerJobFormBean.save}"
                                     styleClass="btn btn-primary" />

                    <h:link outcome="/employerJobOffers.xhtml"
                            value="Cancel"
                            styleClass="btn btn-light" />
                </div>
            </h:form>
        </div>

    </ui:define>
</ui:composition>
